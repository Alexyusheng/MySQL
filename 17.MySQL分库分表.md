# ç¬¬16ç« ã€MySQLåˆ†åº“åˆ†è¡¨

```
1.MyCATåˆ†å¸ƒå¼æ¶æ„å…¥é—¨åŠåŒä¸»æ¶æ„
2.MyCATæ¶æ„éƒ¨ç½²
3.MyCATå®‰è£…
4.MyCATè¯»å†™åˆ†ç¦»æ¶æ„
5.MyCATé«˜å¯ç”¨è¯»å†™åˆ†ç¦»æ¶æ„
6.schema.xmlé…ç½®æ–‡ä»¶è¯¦è§£
7.MyCATå‚ç›´åˆ†è¡¨
8.MyCATæ°´å¹³åˆ†è¡¨-èŒƒå›´åˆ†ç‰‡
9.MyCATæ°´å¹³åˆ†è¡¨-å–æ¨¡åˆ†ç‰‡
10.MyCATæ°´å¹³åˆ†è¡¨-æšä¸¾åˆ†ç‰‡
11.MyCATå…¨å±€è¡¨ä¸ERè¡¨
```



## 1.MyCATåˆ†å¸ƒå¼æ¶æ„å…¥é—¨åŠåŒä¸»æ¶æ„



![MyCATæ¶æ„](G:\å½•åˆ¶è§†é¢‘\å…¶ä»–èµ„æ–™\è¯¾ç¨‹æ‰€éœ€å›¾\MyCATæ¶æ„.jpg)



## 2.MyCATæ¶æ„éƒ¨ç½²

192.168.58.51ï¼š

3306å®‰è£…ï¼šç•¥

3307å®‰è£…ï¼š

    åˆ›å»ºæ•°æ®ç›®å½•
    mkdir -p /data/mysql/mysql3307/{data,logs}
    åˆ›å»ºé…ç½®æ–‡ä»¶
    vim /data/mysql/mysql3307/my3307.cnf
    [mysqld]
    user=mysql
    basedir=/usr/local/mysql
    datadir=/data/mysql/mysql3307/data
    socket = /data/mysql/mysql3307/mysql.sock
    server_id = 2
    port = 3307
    log_error=/data/mysql/mysql3307/logs/error.log
    log_bin=/data/mysql/mysql3307/logs/mysql-bin
    binlog_format=row
    gtid_mode=on
    enforce_gtid_consistency=true
    log_slave_updates=1
    max_connections=1024
    wait_timeout=60
    sort_buffer_size=2M
    max_allowed_packet=32M
    join_buffer_size=2M
    innodb_buffer_pool_size=128M
    innodb_flush_log_at_trx_commit=1
    innodb_log_buffer_size=32M
    innodb_log_file_size=128M
    innodb_log_files_in_group=2
    binlog_cache_size=2M
    max_binlog_cache_size=8M
    max_binlog_size=512M
    expire_logs_days=7
    slow_query_log=on
    slow_query_log_file=/data/mysql/mysql3307/logs/slow.log
    long_query_time=0.5
    log_queries_not_using_indexes=1
    æ›´æ”¹MySQLç›¸å…³ç›®å½•çš„ç”¨æˆ·ç»„
    chown -R mysql:mysql /data/*
    
    åˆå§‹åŒ–æ•°æ®åº“
    /usr/local/mysql/bin/mysqld --defaults-file=/data/mysql/mysql3307/my3307.cnf --initialize-insecure --user=mysql --basedir=/usr/local/mysql  --datadir=/data/mysql/mysql3307/data 
        
    ã€‚å¤šå®ä¾‹çš„å¯åŠ¨å…³é—­
    mysqld --defaults-file=/data/mysql/mysql3307/my3307.cnf &
3308å®ä¾‹å®‰è£…ï¼š

```
åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p /data/mysql/mysql3308/{data,logs}
åˆ›å»ºé…ç½®æ–‡ä»¶
vim /data/mysql/mysql3308/my3308.cnf
[mysqld]
user=mysql
basedir=/usr/local/mysql
datadir=/data/mysql/mysql3308/data
socket = /data/mysql/mysql3308/mysql.sock
server_id = 3
port = 3308
log_error=/data/mysql/mysql3308/logs/error.log
log_bin=/data/mysql/mysql3308/logs/mysql-bin
binlog_format=row
gtid_mode=on
enforce_gtid_consistency=true
log_slave_updates=1
max_connections=1024
wait_timeout=60
sort_buffer_size=2M
max_allowed_packet=32M
join_buffer_size=2M
innodb_buffer_pool_size=128M
innodb_flush_log_at_trx_commit=1
innodb_log_buffer_size=32M
innodb_log_file_size=128M
innodb_log_files_in_group=2
binlog_cache_size=2M
max_binlog_cache_size=8M
max_binlog_size=512M
expire_logs_days=7
slow_query_log=on
slow_query_log_file=/data/mysql/mysql3308/logs/slow.log
long_query_time=0.5
log_queries_not_using_indexes=1
æ›´æ”¹MySQLç›¸å…³ç›®å½•çš„ç”¨æˆ·ç»„
chown -R mysql:mysql /data/*

åˆå§‹åŒ–æ•°æ®åº“
/usr/local/mysql/bin/mysqld --defaults-file=/data/mysql/mysql3308/my3308.cnf --initialize-insecure --user=mysql --basedir=/usr/local/mysql  --datadir=/data/mysql/mysql3308/data 
    
ã€‚å¤šå®ä¾‹çš„å¯åŠ¨å…³é—­
mysqld --defaults-file=/data/mysql/mysql3308/my3308.cnf &
```

3309å®ä¾‹å®‰è£…ï¼š

```
åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p /data/mysql/mysql3309/{data,logs}
åˆ›å»ºé…ç½®æ–‡ä»¶
vim /data/mysql/mysql3309/my3309.cnf
[mysqld]
user=mysql
basedir=/usr/local/mysql
datadir=/data/mysql/mysql3309/data
socket = /data/mysql/mysql3309/mysql.sock
server_id = 4
port = 3309
log_error=/data/mysql/mysql3309/logs/error.log
log_bin=/data/mysql/mysql3309/logs/mysql-bin
binlog_format=row
gtid_mode=on
enforce_gtid_consistency=true
log_slave_updates=1
max_connections=1024
wait_timeout=60
sort_buffer_size=2M
max_allowed_packet=32M
join_buffer_size=2M
innodb_buffer_pool_size=128M
innodb_flush_log_at_trx_commit=1
innodb_log_buffer_size=32M
innodb_log_file_size=128M
innodb_log_files_in_group=2
binlog_cache_size=2M
max_binlog_cache_size=8M
max_binlog_size=512M
expire_logs_days=7
slow_query_log=on
slow_query_log_file=/data/mysql/mysql3309/logs/slow.log
long_query_time=0.5
log_queries_not_using_indexes=1
æ›´æ”¹MySQLç›¸å…³ç›®å½•çš„ç”¨æˆ·ç»„
chown -R mysql:mysql /data/*

åˆå§‹åŒ–æ•°æ®åº“
/usr/local/mysql/bin/mysqld --defaults-file=/data/mysql/mysql3309/my3309.cnf --initialize-insecure --user=mysql --basedir=/usr/local/mysql  --datadir=/data/mysql/mysql3309/data 
    
ã€‚å¤šå®ä¾‹çš„å¯åŠ¨å…³é—­
mysqld --defaults-file=/data/mysql/mysql3309/my3309.cnf &
```

192.168.58.52ï¼š

3306å®‰è£…ï¼šç•¥

3307å®‰è£…ï¼š

    åˆ›å»ºæ•°æ®ç›®å½•
    mkdir -p /data/mysql/mysql3307/{data,logs}
    åˆ›å»ºé…ç½®æ–‡ä»¶
    vim /data/mysql/mysql3307/my3307.cnf
    [mysqld]
    user=mysql
    basedir=/usr/local/mysql
    datadir=/data/mysql/mysql3307/data
    socket = /data/mysql/mysql3307/mysql.sock
    server_id = 12
    port = 3307
    log_error=/data/mysql/mysql3307/logs/error.log
    log_bin=/data/mysql/mysql3307/logs/mysql-bin
    binlog_format=row
    gtid_mode=on
    enforce_gtid_consistency=true
    log_slave_updates=1
    max_connections=1024
    wait_timeout=60
    sort_buffer_size=2M
    max_allowed_packet=32M
    join_buffer_size=2M
    innodb_buffer_pool_size=128M
    innodb_flush_log_at_trx_commit=1
    innodb_log_buffer_size=32M
    innodb_log_file_size=128M
    innodb_log_files_in_group=2
    binlog_cache_size=2M
    max_binlog_cache_size=8M
    max_binlog_size=512M
    expire_logs_days=7
    slow_query_log=on
    slow_query_log_file=/data/mysql/mysql3307/logs/slow.log
    long_query_time=0.5
    log_queries_not_using_indexes=1
    æ›´æ”¹MySQLç›¸å…³ç›®å½•çš„ç”¨æˆ·ç»„
    chown -R mysql:mysql /data/*
    
    åˆå§‹åŒ–æ•°æ®åº“
    /usr/local/mysql/bin/mysqld --defaults-file=/data/mysql/mysql3307/my3307.cnf --initialize-insecure --user=mysql --basedir=/usr/local/mysql  --datadir=/data/mysql/mysql3307/data 
        
    ã€‚å¤šå®ä¾‹çš„å¯åŠ¨å…³é—­
    mysqld --defaults-file=/data/mysql/mysql3307/my3307.cnf &

3308å®ä¾‹å®‰è£…ï¼š

```
åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p /data/mysql/mysql3308/{data,logs}
åˆ›å»ºé…ç½®æ–‡ä»¶
vim /data/mysql/mysql3308/my3308.cnf
[mysqld]
user=mysql
basedir=/usr/local/mysql
datadir=/data/mysql/mysql3308/data
socket = /data/mysql/mysql3308/mysql.sock
server_id = 13
port = 3308
log_error=/data/mysql/mysql3308/logs/error.log
log_bin=/data/mysql/mysql3308/logs/mysql-bin
binlog_format=row
gtid_mode=on
enforce_gtid_consistency=true
log_slave_updates=1
max_connections=1024
wait_timeout=60
sort_buffer_size=2M
max_allowed_packet=32M
join_buffer_size=2M
innodb_buffer_pool_size=128M
innodb_flush_log_at_trx_commit=1
innodb_log_buffer_size=32M
innodb_log_file_size=128M
innodb_log_files_in_group=2
binlog_cache_size=2M
max_binlog_cache_size=8M
max_binlog_size=512M
expire_logs_days=7
slow_query_log=on
slow_query_log_file=/data/mysql/mysql3308/logs/slow.log
long_query_time=0.5
log_queries_not_using_indexes=1
æ›´æ”¹MySQLç›¸å…³ç›®å½•çš„ç”¨æˆ·ç»„
chown -R mysql:mysql /data/*

åˆå§‹åŒ–æ•°æ®åº“
/usr/local/mysql/bin/mysqld --defaults-file=/data/mysql/mysql3308/my3308.cnf --initialize-insecure --user=mysql --basedir=/usr/local/mysql  --datadir=/data/mysql/mysql3308/data 
    
ã€‚å¤šå®ä¾‹çš„å¯åŠ¨å…³é—­
mysqld --defaults-file=/data/mysql/mysql3308/my3308.cnf &
```

3309å®ä¾‹å®‰è£…ï¼š

```
åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p /data/mysql/mysql3309/{data,logs}
åˆ›å»ºé…ç½®æ–‡ä»¶
vim /data/mysql/mysql3309/my3309.cnf
[mysqld]
user=mysql
basedir=/usr/local/mysql
datadir=/data/mysql/mysql3309/data
socket = /data/mysql/mysql3309/mysql.sock
server_id = 14
port = 3309
log_error=/data/mysql/mysql3309/logs/error.log
log_bin=/data/mysql/mysql3309/logs/mysql-bin
binlog_format=row
gtid_mode=on
enforce_gtid_consistency=true
log_slave_updates=1
max_connections=1024
wait_timeout=60
sort_buffer_size=2M
max_allowed_packet=32M
join_buffer_size=2M
innodb_buffer_pool_size=128M
innodb_flush_log_at_trx_commit=1
innodb_log_buffer_size=32M
innodb_log_file_size=128M
innodb_log_files_in_group=2
binlog_cache_size=2M
max_binlog_cache_size=8M
max_binlog_size=512M
expire_logs_days=7
slow_query_log=on
slow_query_log_file=/data/mysql/mysql3309/logs/slow.log
long_query_time=0.5
log_queries_not_using_indexes=1
æ›´æ”¹MySQLç›¸å…³ç›®å½•çš„ç”¨æˆ·ç»„
chown -R mysql:mysql /data/*

åˆå§‹åŒ–æ•°æ®åº“
/usr/local/mysql/bin/mysqld --defaults-file=/data/mysql/mysql3309/my3309.cnf --initialize-insecure --user=mysql --basedir=/usr/local/mysql  --datadir=/data/mysql/mysql3309/data 
    
ã€‚å¤šå®ä¾‹çš„å¯åŠ¨å…³é—­
mysqld --defaults-file=/data/mysql/mysql3309/my3309.cnf &
```

MyCATæ¶æ„ï¼š

![1626315101863](G:\å½•åˆ¶è§†é¢‘\å…¶ä»–èµ„æ–™\MyCATæ¶æ„.jpg)



åˆ›å»ºå¤åˆ¶ç”¨æˆ·51:3306æ‰§è¡Œï¼š

create user repl@'%'  identified by '123456';

```
grant replication slave on *.* to repl@'%';
```

åˆ›å»ºå¤åˆ¶ç”¨æˆ·51:3307æ‰§è¡Œï¼š

create user repl@'%'  identified by '123456';

```
create user repl@'%'  identified by '123456';
```



m1<--->sm1

â€‹	192.168.58.51:3306 <--->192.168.58.52:3306

â€‹	192.168.58.51:3306 --->192.168.58.51:3308

â€‹	192.168.58.52:3306 --->192.168.58.52:3308



192.168.58.52:3306

	CHANGE MASTER TO
	  MASTER_HOST='192.168.58.51',
	  MASTER_USER='repl',
	  MASTER_PASSWORD='123456',
	  MASTER_PORT=3306,
	  master_auto_position=1,
	  MASTER_CONNECT_RETRY=10;
	start slave;
192.168.58.51:3306

```
CHANGE MASTER TO
  MASTER_HOST='192.168.58.52',
  MASTER_USER='repl',
  MASTER_PASSWORD='123456',
  MASTER_PORT=3306,
  master_auto_position=1,
  MASTER_CONNECT_RETRY=10;
start slave;
```

192.168.58.51:3308

```
CHANGE MASTER TO
  MASTER_HOST='192.168.58.51',
  MASTER_USER='repl',
  MASTER_PASSWORD='123456',
  MASTER_PORT=3306,
  master_auto_position=1,
  MASTER_CONNECT_RETRY=10;
start slave;
```

192.168.58.52:3308

```
CHANGE MASTER TO
  MASTER_HOST='192.168.58.52',
  MASTER_USER='repl',
  MASTER_PASSWORD='123456',
  MASTER_PORT=3306,
  master_auto_position=1,
  MASTER_CONNECT_RETRY=10;
start slave;
```



m2<--->sm2

â€‹	192.168.58.52:3307 <--->192.168.58.51:3307

â€‹	192.168.58.52:3307 --->192.168.58.52:3309

â€‹	192.168.58.51:3307 --->192.168.58.51:3309



192.168.58.52:3307

```
CHANGE MASTER TO
  MASTER_HOST='192.168.58.51',
  MASTER_USER='repl',
  MASTER_PASSWORD='123456',
  MASTER_PORT=3307,
  master_auto_position=1,
  MASTER_CONNECT_RETRY=10;
start slave;
```

192.168.58.51:3307

```
CHANGE MASTER TO
  MASTER_HOST='192.168.58.52',
  MASTER_USER='repl',
  MASTER_PASSWORD='123456',
  MASTER_PORT=3307,
  master_auto_position=1,
  MASTER_CONNECT_RETRY=10;
start slave;
```

192.168.58.52:3309

```
CHANGE MASTER TO
  MASTER_HOST='192.168.58.52',
  MASTER_USER='repl',
  MASTER_PASSWORD='123456',
  MASTER_PORT=3307,
  master_auto_position=1,
  MASTER_CONNECT_RETRY=10;
start slave;
```

192.168.58.51:3309

```
CHANGE MASTER TO
  MASTER_HOST='192.168.58.51',
  MASTER_USER='repl',
  MASTER_PASSWORD='123456',
  MASTER_PORT=3307,
  master_auto_position=1,
  MASTER_CONNECT_RETRY=10;
start slave;
```

## 3.MyCATå®‰è£…

ã€‚é¢„å…ˆå®‰è£…Javaè¿è¡Œç¯å¢ƒ

yum install -y java

java -version



cd /server/tools

rz

ä¸‹è½½Mycat-server-xxxxx.linux.tar.gz

http://dl.mycat.org.cn/

wget http://dl.mycat.org.cn/1.6.5/Mycat-server-1.6.5-release-20180122220033-linux.tar.gz

 

è§£å‹æ–‡ä»¶

tar zxf Mycat-server-1.6.5-release-20180122220033-linux.tar.gz

mv mycat/ /usr/local/





é…ç½®ç¯å¢ƒå˜é‡

vim /etc/profile

PATH="/usr/local/mysql/bin:/usr/local/mycat/bin:$PATH"

. /etc/profile



å¯åŠ¨å’Œè¿æ¥

mycat start

 

è¿æ¥mycatï¼š

mysql -uroot -p123456 -h 127.0.0.1 -P8066 å¯¹å¤–è¿æ¥(root 123456æ˜¯server.xmlé…ç½®æ–‡ä»¶ä¸­çš„)

9066 å¯¹å†…ç«¯å£

 

æŸ¥çœ‹mycatè‡ªå¸¦çš„è¡¨

use TESTDB; é»˜è®¤åº“

show tables;

 

é…ç½®æ–‡ä»¶ä»‹ç»

schema.xml    ----->ä¸»é…ç½®æ–‡ä»¶ï¼ˆè¯»å†™åˆ†ç¦»ã€é«˜å¯ç”¨ã€åˆ†è¡¨ã€èŠ‚ç‚¹æ§åˆ¶ï¼‰

server.xml		 ----->mycatè½¯ä»¶æœ¬èº«ç›¸å…³çš„é…ç½®

rule.xml     ----->åˆ†ç‰‡è§„åˆ™é…ç½®æ–‡ä»¶ï¼ˆåˆ†ç‰‡è§„åˆ™åˆ—è¡¨ã€ä½¿ç”¨æ–¹æ³•ï¼‰



## 4.MyCATè¯»å†™åˆ†ç¦»æ¶æ„

![1626315101863](G:\å½•åˆ¶è§†é¢‘\å…¶ä»–èµ„æ–™\MyCATæ¶æ„.jpg)

51:3306:

â€‹	create user root@'%' identified by '123456';

â€‹	grant all on *.* to root@'%';

52:3307:

â€‹	create user root@'%' identified by '123456';

â€‹	grant all on *.* to root@'%';



1ä¸»1ä»ï¼šè¯»å†™åˆ†ç¦»æ¶æ„

192.168.58.51

â€‹	3306 w 1

â€‹	3308 r 3

```
<?xml version="1.0"?>  
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">  
<mycat:schema xmlns:mycat="http://io.mycat/">
<schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1"> 
</schema>  
	<dataNode name="dn1" dataHost="localhost1" database= "ergou" />  
	<dataHost name="localhost1" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1"> 
		<heartbeat>select user()</heartbeat>  
	<writeHost host="db1" url="192.168.58.51:3306" user="root" password="123456"> 
		<readHost host="db2" url="192.168.58.51:3308" user="root" password="123456" /> 
	</writeHost> 
	</dataHost>  
</mycat:schema>
```



## 5.MyCATé«˜å¯ç”¨è¯»å†™åˆ†ç¦»æ¶æ„

![1626315101863](/Users/alexyusheng/å°ğŸŸçš„æ–‡ç¨¿/MySQL_çŸ¥è¯†ç‚¹/è¯¾ç¨‹æ‰€éœ€å›¾/MyCATæ¶æ„.jpg)

```
51:3306ã€3308
52:3306ã€3308
w:11
r:1/3/13

<?xml version="1.0"?>  
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">  
<mycat:schema xmlns:mycat="http://io.mycat/">
<schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1"> 
</schema>  
	<dataNode name="dn1" dataHost="localhost1" database= "ergou" />  
	<dataHost name="localhost1" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1"> 
		<heartbeat>select user()</heartbeat>  
	<writeHost host="db1" url="192.168.58.51:3306" user="root" password="123456"> 
		<readHost host="db2" url="192.168.58.51:3308" user="root" password="123456" /> 
	</writeHost> 
	<writeHost host="db3" url="192.168.58.52:3306" user="root" password="123456"> 
		<readHost host="db4" url="192.168.58.52:3308" user="root" password="123456" /> 
	</writeHost> 
	</dataHost>  
</mycat:schema>
```



## 6.schema.xmlé…ç½®æ–‡ä»¶è¯¦è§£

```
<?xml version="1.0"?>  
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">  
<mycat:schema xmlns:mycat="http://io.mycat/">
<schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1"> 
<table name="country" dataNode="dn2"/>
</schema>  
	<dataNode name="dn1" dataHost="localhost1" database= "ergou" />  
	<dataHost name="localhost1" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1"> 
		<heartbeat>select user()</heartbeat>  
		<writeHost host="db1" url="192.168.58.51:3306" user="root" password="123456"> 
			<readHost host="db2" url="192.168.58.51:3308" user="root" password="123456" /> 
		</writeHost> 
	</dataHost>  
</mycat:schema>
```



```
ï¼ˆ1ï¼‰schemaæ ‡ç­¾ï¼šç”¨äºå®šä¹‰é€»è¾‘åº“
<schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1"> </schema>  
dataNode="dn1" æŒ‡é€»è¾‘åº“é»˜è®¤çš„åˆ†ç‰‡
checkSQLschema="false" 
å½“åº”ç”¨æ‰§è¡Œã€select *fromÂ TESTDB.tf_user;ã€‘æ—¶ï¼ˆè¡¨åå‰æŒ‡å®šäº†mycaté€»è¾‘åº“åï¼‰ï¼Œä¸¤ç§å–å€¼ï¼š
trueï¼šmycatä¼šæŠŠè¯­å¥è½¬æ¢ä¸ºã€select * from tf_user;ã€‘
falseï¼šä¼šæŠ¥é”™
sqlMaxLimit="100"
ç›¸å½“äºsqlçš„ç»“æœé›†ä¸­ï¼ŒåŠ ä¸Šã€limit Nã€‘ã€‚å¦‚æœsqlæœ¬èº«å·²ç»æŒ‡å®šlimitï¼Œåˆ™ä»¥sqlæŒ‡å®šçš„ä¸ºå‡†ã€‚

ï¼ˆ2ï¼‰tableæ ‡ç­¾ï¼šæ˜¯shcemaæ ‡ç­¾çš„å­æ ‡ç­¾ï¼Œç”¨äºå®šä¹‰é€»è¾‘è¡¨åŠé€»è¾‘è¡¨çš„åˆ†ç‰‡è§„åˆ™
<table name="country" dataNode="sh2"/>
nameå±æ€§ï¼šé€»è¾‘è¡¨çš„è¡¨åï¼ŒåŒä¸€ä¸ªschemaè¡¨åå¿…é¡»å”¯ä¸€ã€‚
dataNodeå±æ€§ï¼šå®šä¹‰è¿™ä¸ªé€»è¾‘è¡¨æ‰€å±çš„åˆ†ç‰‡ï¼Œç”¨è‹±æ–‡é€—å·é—´éš”ï¼Œå¦‚ï¼šdataNode="dn1,dn2"
ruleå±æ€§ï¼šè¯¥å±æ€§ç”¨äºæŒ‡å®šé€»è¾‘è¡¨è¦ä½¿ç”¨çš„è§„åˆ™åå­—ï¼Œè§„åˆ™åå­—åœ¨ rule.xml ä¸­å®šä¹‰ï¼Œå¿…é¡»ä¸ tableRule æ ‡ç­¾ä¸­ name å±æ€§å±æ€§å€¼ä¸€ä¸€å¯¹åº”ã€‚
Â 		ruleRequiredå±æ€§ï¼šè¯¥å±æ€§ç”¨äºæŒ‡å®šè¡¨æ˜¯å¦ç»‘å®šåˆ†ç‰‡è§„åˆ™ï¼Œå¦‚æœé…ç½®ä¸º trueï¼Œä½†æ²¡æœ‰é…ç½®å…·ä½“ rule çš„è¯ ï¼Œç¨‹åºä¼šæŠ¥é”™
primaryKeyå±æ€§ï¼šæŒ‡å®šè¯¥é€»è¾‘è¡¨å¯¹åº”çœŸå®è¡¨çš„ä¸»é”®ã€‚MyCatä¼šç¼“å­˜ä¸»é”®ï¼ˆé€šè¿‡primaryKeyå±æ€§é…ç½®ï¼‰ä¸å…·ä½“ dataNodeçš„ä¿¡æ¯ã€‚å½“åˆ†ç‰‡è§„åˆ™ä½¿ç”¨éä¸»é”®è¿›è¡Œåˆ†ç‰‡æ—¶ï¼Œé‚£ä¹ˆåœ¨ä½¿ç”¨ä¸»é”®è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼ŒMyCatå°±ä¼šé€šè¿‡ç¼“å­˜å…ˆç¡®å®šè®°å½•åœ¨å“ªä¸ªdataNodeä¸Šï¼Œç„¶åå†åœ¨è¯¥dataNodeä¸Šæ‰§è¡ŒæŸ¥è¯¢ã€‚å¦‚æœç¼“å­˜å¹¶æ²¡æœ‰å‘½ä¸­çš„è¯ï¼Œè¿˜æ˜¯ä¼šå‘é€è¯­å¥ç»™æ‰€æœ‰çš„dataNodeã€‚
å…³äºMycatçš„ä¸»é”®ç¼“å­˜ï¼Œå…¶æœºåˆ¶æ˜¯ï¼šå½“æ ¹æ®ä¸»é”®æŸ¥è¯¢çš„SQLè¯­å¥ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ï¼ŒMycatä¼šå¯¹å…¶ç»“æœè¿›è¡Œåˆ†æï¼Œç¡®å®šè¯¥ä¸»é”®åœ¨å“ªä¸ªåˆ†ç‰‡ä¸Šï¼Œå¹¶è¿›è¡Œè¯¥ä¸»é”®åˆ°åˆ†ç‰‡IDçš„ç¼“å­˜ã€‚é€šè¿‡è¿æ¥MyCATçš„9066ç®¡ç†ç«¯å£ï¼Œæ‰§è¡Œshow@@cacheï¼Œå¯ä»¥æ˜¾ç¤ºå½“å‰ç¼“å­˜çš„ä½¿ç”¨æƒ…å†µã€‚å¯åœ¨sqlæ‰§è¡Œå‰åçš„2ä¸ªæ—¶é—´ç‚¹æ‰§è¡Œshow @@cacheï¼Œé€šè¿‡ç»“æœä¿¡æ¯ä¸­çš„LAST_PUTå’ŒLAST_ACCESSåˆ—ï¼Œåˆ¤æ–­ç›¸åº”è¡¨çš„ç¼“å­˜æ˜¯å¦æœ‰è¢«æ›´æ–°è¿‡ã€‚
    	Â typeå±æ€§ï¼šè¯¥å±æ€§å®šä¹‰äº†é€»è¾‘è¡¨çš„ç±»å‹ï¼Œç›®å‰é€»è¾‘è¡¨åªæœ‰â€œå…¨å±€è¡¨â€å’Œâ€æ™®é€šè¡¨â€ä¸¤ç§ç±»å‹ã€‚å¯¹åº”çš„é…ç½®ï¼šå…¨å±€è¡¨ï¼šglobalã€‚æ™®é€šè¡¨ï¼šä¸æŒ‡å®šè¯¥å€¼ä¸º global çš„æ‰€æœ‰è¡¨ã€‚

ï¼ˆ3ï¼‰dataNodeæ ‡ç­¾ï¼š
<dataNode name="dn1" dataHost="localhost1" database= "ergou" /> 
Â 	name å±æ€§ï¼šæŒ‡å®šåˆ†ç‰‡çš„åå­—
dataHost å±æ€§ï¼šå®šä¹‰è¯¥åˆ†ç‰‡å±äºå“ªä¸ªæ•°æ®åº“å®ä¾‹
database å±æ€§ï¼šå®šä¹‰è¯¥åˆ†ç‰‡å±äºå“ªä¸ªå…·ä½“æ•°æ®åº“å®ä¾‹ä¸Šçš„å…·ä½“åº“ï¼ˆå³å¯¹åº”mysqlä¸­å®é™…çš„DBï¼‰

ï¼ˆ4ï¼‰dataHostæ ‡ç­¾ï¼šç”¨äºå®šä¹‰åç«¯çœŸå®æ•°æ®åº“å®ä¾‹
<dataHost name="localhost1" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1"> 
		<heartbeat>select user()</heartbeat>  
		<writeHost host="db1" url="192.168.58.51:3307" user="root" password="123"> 
			<readHost host="db2" url="192.168.58.51:3309" user="root" password="123" /> 
		</writeHost> 
</dataHost>
minConæœ€å°å¹¶å‘è¿æ¥æ•°
maxConæœ€å¤§å¹¶å‘è¿æ¥æ•°
 balance å±æ€§
è´Ÿè½½å‡è¡¡ç±»å‹ï¼š
balance="0", ä¸å¼€å¯è¯»å†™åˆ†ç¦»æœºåˆ¶ï¼Œæ‰€æœ‰è¯»æ“ä½œéƒ½å‘é€åˆ°å½“å‰å¯ç”¨çš„writeHost ä¸Šã€‚
balance="1"ï¼Œå…¨éƒ¨çš„ readHost ä¸ stand by writeHost å‚ä¸ select è¯­å¥çš„è´Ÿè½½å‡è¡¡ï¼Œç®€å•çš„è¯´ï¼Œå½“åŒä¸»åŒä»æ¨¡å¼(M1->S1ï¼ŒM2->S2ï¼Œå¹¶ä¸” M1 ä¸ M2 äº’ä¸ºä¸»å¤‡)ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼ŒM2,S1,S2 éƒ½å‚ä¸ select è¯­å¥çš„è´Ÿè½½å‡è¡¡ã€‚
balance="2"ï¼Œæ‰€æœ‰è¯»æ“ä½œéƒ½éšæœºçš„åœ¨ writeHostã€ readhost ä¸Šåˆ†å‘ã€‚
writeType å±æ€§
	writeType="0", æ‰€æœ‰å†™æ“ä½œå‘é€åˆ°é…ç½®çš„ç¬¬ä¸€ä¸ª writeHostï¼Œç¬¬ä¸€ä¸ªæŒ‚äº†åˆ‡åˆ°è¿˜ç”Ÿå­˜çš„ç¬¬äºŒä¸ªwriteHostï¼Œé‡æ–°å¯åŠ¨åå·²åˆ‡æ¢åçš„ä¸ºå‡†ï¼Œåˆ‡æ¢è®°å½•åœ¨é…ç½®æ–‡ä»¶ä¸­:dnindex.properties.
	writeType="1"ï¼Œæ‰€æœ‰å†™æ“ä½œéƒ½éšæœºçš„å‘é€åˆ°é…ç½®çš„ writeHostï¼Œ1.5 ä»¥ååºŸå¼ƒä¸æ¨èã€‚ä¸MHAé…åˆä½¿ç”¨æ—¶ï¼Œå¿…é¡»è®¾ç½®ä¸º1
dbType å±æ€§:æŒ‡å®šåç«¯è¿æ¥çš„æ•°æ®åº“ç±»å‹ï¼Œç›®å‰æ”¯æŒäºŒè¿›åˆ¶çš„ mysql åè®®ï¼Œè¿˜æœ‰å…¶ä»–ä½¿ç”¨ JDBC è¿æ¥çš„æ•°æ®åº“ã€‚ä¾‹å¦‚ï¼šmongodbã€ oracleã€ spark ç­‰ã€‚

dbDriver å±æ€§
æŒ‡å®šè¿æ¥åç«¯æ•°æ®åº“ä½¿ç”¨çš„ Driverï¼Œç›®å‰å¯é€‰çš„å€¼æœ‰ native å’Œ JDBCã€‚ä½¿ç”¨native çš„è¯ï¼Œå› ä¸ºè¿™ä¸ªå€¼æ‰§è¡Œçš„æ˜¯äºŒè¿›åˆ¶çš„ mysql åè®®ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ mysql å’Œ maridbã€‚å…¶ä»–ç±»å‹çš„æ•°æ®åº“åˆ™éœ€è¦ä½¿ç”¨ JDBC é©±åŠ¨æ¥æ”¯æŒã€‚
switchTypeå±æ€§ï¼šä¸»èŠ‚ç‚¹å®•æœºååˆ‡æ¢æ¨¡å¼
-1 ä¸è‡ªåŠ¨åˆ‡æ¢
1 è‡ªåŠ¨åˆ‡æ¢
2 åŸºäºmysqlä¸»ä»åŒæ­¥çŠ¶æ€ï¼ˆåŒæ­¥ï¼Œå»¶æ—¶ï¼‰å†³å®šæ˜¯å¦åˆ‡æ¢ï¼Œå¿ƒè·³è¯­å¥æ˜¯ show slave status

* slaveThreshold ä¸»ä»å»¶æ—¶æ—¶é—´
```



## 7.MyCATå‚ç›´åˆ†è¡¨

![1626315101863](/Users/alexyusheng/å°ğŸŸçš„æ–‡ç¨¿/MySQL_çŸ¥è¯†ç‚¹/è¯¾ç¨‹æ‰€éœ€å›¾/MyCATæ¶æ„.jpg)

```
<?xml version="1.0"?>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">
<mycat:schema xmlns:mycat="http://io.mycat/">
<schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1">
        <table name="t" dataNode="dn1"/>
		<table name="t1" dataNode="dn2"/>
</schema>
    <dataNode name="dn1" dataHost="localhost1" database= "ergou" />
    <dataNode name="dn2" dataHost="localhost2" database= "ergou" />
    <dataHost name="localhost1" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1">
        <heartbeat>select user()</heartbeat>
    <writeHost host="db1" url="192.168.58.51:3306" user="root" password="123456">
            <readHost host="db2" url="192.168.58.51:3308" user="root" password="123456" />
    </writeHost>
    <writeHost host="db3" url="192.168.58.52:3306" user="root" password="123456">
            <readHost host="db4" url="192.168.58.52:3308" user="root" password="123456" />
    </writeHost>
</dataHost>

    <dataHost name="localhost2" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1">
        <heartbeat>select user()</heartbeat>
    <writeHost host="db1" url="192.168.58.52:3307" user="root" password="123456">
            <readHost host="db2" url="192.168.58.52:3309" user="root" password="123456" />
    </writeHost>
    <writeHost host="db3" url="192.168.58.51:3307" user="root" password="123456">
            <readHost host="db4" url="192.168.58.51:3309" user="root" password="123456" />
    </writeHost>
    </dataHost>
</mycat:schema>
```

## 8.MyCATæ°´å¹³åˆ†è¡¨-èŒƒå›´åˆ†ç‰‡



![1626315101863](MyCAT%E6%9E%B6%E6%9E%84.jpg)

```
vim schema.xml

<?xml version="1.0"?>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">
<mycat:schema xmlns:mycat="http://io.mycat/">
<schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1">
        <table name="t3" dataNode="dn1,dn2" rule="auto-sharding-long" /> 
</schema>
    <dataNode name="dn1" dataHost="localhost1" database= "ergou" />
    <dataNode name="dn2" dataHost="localhost2" database= "ergou" />
    <dataHost name="localhost1" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1">
        <heartbeat>select user()</heartbeat>
    <writeHost host="db1" url="192.168.58.51:3306" user="root" password="123456">
            <readHost host="db2" url="192.168.58.51:3308" user="root" password="123456" />
    </writeHost>
    <writeHost host="db3" url="192.168.58.52:3306" user="root" password="123456">
            <readHost host="db4" url="192.168.58.52:3308" user="root" password="123456" />
    </writeHost>
</dataHost>

    <dataHost name="localhost2" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1">
        <heartbeat>select user()</heartbeat>
    <writeHost host="db1" url="192.168.58.52:3307" user="root" password="123456">
            <readHost host="db2" url="192.168.58.52:3309" user="root" password="123456" />
    </writeHost>
    <writeHost host="db3" url="192.168.58.51:3307" user="root" password="123456">
            <readHost host="db4" url="192.168.58.51:3309" user="root" password="123456" />
    </writeHost>
    </dataHost>
</mycat:schema>
```

vim rule.xml 

0-10=0
11-20=1

## 9.MyCATæ°´å¹³åˆ†è¡¨-å–æ¨¡åˆ†ç‰‡

```
vim schema.xml

<?xml version="1.0"?>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">
<mycat:schema xmlns:mycat="http://io.mycat/">
<schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1">
        <table name="t4" dataNode="dn1,dn2" rule="mod-long" /> 
</schema>
    <dataNode name="dn1" dataHost="localhost1" database= "ergou" />
    <dataNode name="dn2" dataHost="localhost2" database= "ergou" />
    <dataHost name="localhost1" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1">
        <heartbeat>select user()</heartbeat>
    <writeHost host="db1" url="192.168.58.51:3306" user="root" password="123456">
            <readHost host="db2" url="192.168.58.51:3308" user="root" password="123456" />
    </writeHost>
    <writeHost host="db3" url="192.168.58.52:3306" user="root" password="123456">
            <readHost host="db4" url="192.168.58.52:3308" user="root" password="123456" />
    </writeHost>
</dataHost>

    <dataHost name="localhost2" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1">
        <heartbeat>select user()</heartbeat>
    <writeHost host="db1" url="192.168.58.52:3307" user="root" password="123456">
            <readHost host="db2" url="192.168.58.52:3309" user="root" password="123456" />
    </writeHost>
    <writeHost host="db3" url="192.168.58.51:3307" user="root" password="123456">
            <readHost host="db4" url="192.168.58.51:3309" user="root" password="123456" />
    </writeHost>
    </dataHost>
</mycat:schema>
```

vim rule.xml

<function name="mod-long" class="io.mycat.route.function.PartitionByMod">
                <!-- how many data nodes -->
                <property name="count">2</property>
        </function>

## 10.MyCATæ°´å¹³åˆ†è¡¨-æšä¸¾åˆ†ç‰‡

```
vim schema.xml

<?xml version="1.0"?>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">
<mycat:schema xmlns:mycat="http://io.mycat/">
<schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1">
        <table name="t5" dataNode="dn1,dn2" rule="sharding-by-intfile" /> 
</schema>
    <dataNode name="dn1" dataHost="localhost1" database= "ergou" />
    <dataNode name="dn2" dataHost="localhost2" database= "ergou" />
    <dataHost name="localhost1" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1">
        <heartbeat>select user()</heartbeat>
    <writeHost host="db1" url="192.168.58.51:3306" user="root" password="123456">
            <readHost host="db2" url="192.168.58.51:3308" user="root" password="123456" />
    </writeHost>
    <writeHost host="db3" url="192.168.58.52:3306" user="root" password="123456">
            <readHost host="db4" url="192.168.58.52:3308" user="root" password="123456" />
    </writeHost>
</dataHost>

    <dataHost name="localhost2" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1">
        <heartbeat>select user()</heartbeat>
    <writeHost host="db1" url="192.168.58.52:3307" user="root" password="123456">
            <readHost host="db2" url="192.168.58.52:3309" user="root" password="123456" />
    </writeHost>
    <writeHost host="db3" url="192.168.58.51:3307" user="root" password="123456">
            <readHost host="db4" url="192.168.58.51:3309" user="root" password="123456" />
    </writeHost>
    </dataHost>
</mycat:schema>
```

## 11.MyCATå…¨å±€è¡¨ä¸ERè¡¨

MyCAT-å…¨å±€è¡¨

```
vim schema.xml

<?xml version="1.0"?>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">
<mycat:schema xmlns:mycat="http://io.mycat/">
<schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1">
        <table name="t6" primaryKey="id" type="global" dataNode="dn1,dn2" />
</schema>
    <dataNode name="dn1" dataHost="localhost1" database= "ergou" />
    <dataNode name="dn2" dataHost="localhost2" database= "ergou" />
    <dataHost name="localhost1" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1">
        <heartbeat>select user()</heartbeat>
    <writeHost host="db1" url="192.168.58.51:3306" user="root" password="123456">
            <readHost host="db2" url="192.168.58.51:3308" user="root" password="123456" />
    </writeHost>
    <writeHost host="db3" url="192.168.58.52:3306" user="root" password="123456">
            <readHost host="db4" url="192.168.58.52:3308" user="root" password="123456" />
    </writeHost>
</dataHost>

    <dataHost name="localhost2" maxCon="1000" minCon="10" balance="1"  writeType="0" dbType="mysql"  dbDriver="native" switchType="1">
        <heartbeat>select user()</heartbeat>
    <writeHost host="db1" url="192.168.58.52:3307" user="root" password="123456">
            <readHost host="db2" url="192.168.58.52:3309" user="root" password="123456" />
    </writeHost>
    <writeHost host="db3" url="192.168.58.51:3307" user="root" password="123456">
            <readHost host="db4" url="192.168.58.51:3309" user="root" password="123456" />
    </writeHost>
    </dataHost>
</mycat:schema>
```

MyCAT-ERè¡¨

```
<table name="t_order_0" primaryKey="id" dataNode="dn1,dn2" rule="mod-long" >
         <childTable name="t_order_item_0" primaryKey="id" joinKey="order_id" parentKey="order_id" >
         </childTable>
</table>

```

